import{Context}from"./Context.min.js";class Element extends HTMLElement{static SCRIPT_TTL=3e5;constructor(t){super(),this.templateSrc=t,this.shadow=this.attachShadow({mode:"open"}),this.pendingRender=null,this.scriptCache=new Map,this.intersectionObserver=null,this.Context=new Context(this._deferRender.bind(this),this.hasAttribute.bind(this),this.getAttribute.bind(this)),this.extendContext(),this.initLazyLoading()}_deferRender(){this.pendingRender=!0,queueMicrotask(()=>{this.updateDynamicContent(),this.pendingRender=!1})}rendered(){}onConnected(){}extendContext(){}static get observedAttributes(){return[]}attributeChangedCallback(t,e,r){e!==r&&this._deferRender()}reexecuteDynamicScripts(){this.Context.hookIndex=0,this.shadow.querySelectorAll("*").forEach(t=>{var e=t.cloneNode(!0);t.parentNode.replaceChild(e,t)});var t=[...this.shadow.querySelectorAll("script[data-dynamic]")];t.forEach(t=>t.remove()),t.forEach(async e=>{let r=document.createElement("script");e.getAttributeNames().forEach(t=>{r.setAttribute(t,e.getAttribute(t))}),e.textContent.trim()?(r.textContent=e.textContent,this.executeScript(r,this.shadow)):e.hasAttribute("src")&&await this.processExternalScript(e,r,!0,this.shadow)})}loadResources(){this.render()}async render(){try{var t=await(await fetch(this.templateSrc)).text();this.template=document.createElement("template"),this.template.innerHTML=t,this.fragment=this.template.content.cloneNode(!0),this.processSlots(this.fragment),this.shadow.appendChild(this.fragment),await this.processScripts(this.shadow),this.onConnected()}catch(t){console.error("Error al cargar el template:",t)}}wrapScriptCode(t){return`
	    (function(document) {
	      {${t};};
	    }).call(window.component, window.component.shadow);
	  `}executeScript(t){Object.entries(this.Context.callbacks).forEach(([t,e])=>{"function"==typeof e?window[t]=e:console.log(`No se puede ejecutar ${t} porque no es una funciÃ³n: `+typeof e)}),window.ctx=this.Context,(window.component=this).shadow.appendChild(t)}async processScripts(t){t=[...t.querySelectorAll("script")];t.forEach(t=>t.remove());for(let r of t){let e=document.createElement("script");r.getAttributeNames().forEach(t=>{e.setAttribute(t,r.getAttribute(t))});var i=r.hasAttribute("data-dynamic");r.textContent.trim()?this.processInlineScript(r,e,i,this.shadow):r.hasAttribute("src")&&await this.processExternalScript(r,e,i,this.shadow)}}processInlineScript(t,e,r=this.shadow){t=this.wrapScriptCode(t.textContent);e.textContent=t,this.executeScript(e,r)}async processExternalScript(e,t,r=this.shadow){e=e.getAttribute("src");if(this.scriptCache.has(e)){var i=this.scriptCache.get(e);if(Date.now()-i.timestamp<Element.SCRIPT_TTL)return t.src=i.url,void this.executeScript(t,r);URL.revokeObjectURL(i.url),this.scriptCache.delete(e)}try{var s=await(await fetch(e)).text(),n=this.wrapScriptCode(s),a=new Blob([n],{type:"application/javascript"}),o=URL.createObjectURL(a);this.scriptCache.set(e,{url:o,timestamp:Date.now()}),t.src=o,this.executeScript(t,r)}catch(t){console.error("Error al procesar script externo: "+e,t)}}processSlots(t){t.querySelectorAll("slot").forEach(t=>{t.setAttribute("aria-live","polite"),t.setAttribute("aria-relevant","additions removals")})}updateDynamicContent(){this.performUpdate(),this.rendered()}performUpdate(){Object.entries(this.Context.dynamicCallbacks).forEach((e,{callback:t,metadata:r})=>{if(this.hasAttribute(e)&&this.getAttribute(e)!==r.oldData)try{t(this.getAttribute(e),r),r.oldData=this.getAttribute(e)}catch(t){console.error(`Error en callback para ${e}:`,t)}}),this.reexecuteDynamicScripts()}initLazyLoading(){"IntersectionObserver"in window?(this.intersectionObserver=new IntersectionObserver(t=>{t[0].isIntersecting&&(this.loadResources(),this.intersectionObserver.disconnect())},{rootMargin:"0px 0px 200px 0px"}),this.intersectionObserver.observe(this)):this.loadResources()}}export{Element};